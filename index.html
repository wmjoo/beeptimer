<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ë¹„í”„ íƒ€ì´ë¨¸</title>
<style>
  :root { color-scheme: light dark; }
  * { box-sizing: border-box; }
  body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Pretendard, sans-serif; margin:0; }
  .container { max-width: 980px; margin: 0 auto; padding: 20px; }
  .clock { font-size: 3rem; font-weight: 800; letter-spacing: .02em; text-align: center; margin: 6px 0 16px; font-variant-numeric: tabular-nums; }
  .panel { border: 1px solid #bbb; border-radius: 12px; padding: 14px; }
  .row { display:flex; gap:10px; align-items:center; flex-wrap: wrap; margin-bottom:10px; }
  .btn { border:0; border-radius:10px; padding:10px 16px; cursor:pointer; font-weight:700; background:#1a73e8; color:#fff; }
  .btn.secondary { background:#666; }
  .btn:disabled { opacity:.5; cursor:not-allowed; }
  label.field { display:inline-flex; align-items:center; gap:6px; }
  input[type="number"], select { padding: 8px 10px; border-radius: 8px; border: 1px solid #aaa; font-size: 0.98rem; }
  input[type="number"] { width: 100px; }
  .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-variant-numeric: tabular-nums; }
  .big { font-size: 1.9rem; font-weight: 800; }
  .hint { color:#777; font-size:.9rem; }
  .status { margin-top: 6px; }
  .ok { color: #1b7f1b; } .warn { color:#b06b00; } .err { color:#b00020; }
  .kv { display:grid; grid-template-columns: 140px 1fr; gap:8px 12px; align-items:center; }
  .kv .label { color:#666; }

  /* í•˜ë‹¨ ì˜¤ë””ì˜¤ ì„¤ì • */
  .audio-panel { margin-top: 16px; }
  .slider { width: 100%; }
  .test-row { display:flex; gap:8px; }

  /* 2ì—´ 1í–‰ ê·¸ë¦¬ë“œ */
  .grid-2 { display: grid; grid-template-columns: repeat(2, minmax(180px, 1fr)); gap: 12px; }
  @media (max-width: 700px) { .grid-2 { grid-template-columns: 1fr; } }
</style>
</head>
<body>
  <div class="container">
    <div id="clock" class="clock mono">--:--:--</div>

    <div class="panel">
      <div class="row">
        <button id="btnStart" class="btn">Start</button>
        <button id="btnStop" class="btn secondary" disabled>Stop</button>

        <label class="field">
          <span>ê°„ê²© n(ì´ˆ):</span>
          <input id="inpN" type="number" min="1" max="60" step="1" value="15" />
        </label>

        <label class="field">
          <input type="checkbox" id="chkAlign" checked />
          <span>:00 ì •ê°ì— ë™ê¸°í™”</span>
        </label>

        <label class="field">
          <input type="checkbox" id="chkIncludeZero" />
          <span>ì •ê°(0ì´ˆ)ì—ë„ ìš¸ë¦¬ê¸°</span>
        </label>

        <label class="field">
          <input type="checkbox" id="chkVisualBeep" checked />
          <span>ë¹„í”„ ì‹œ í™”ë©´ ê¹œë°•ì„</span>
        </label>
      </div>

      <div class="kv" style="margin-top:6px;">
        <div class="label">ë‹¤ìŒ ë¹„í”„ê¹Œì§€:</div>
        <div id="countdown" class="mono big">-</div>

        <div class="label">ë‹¤ìŒ ë¹„í”„ ì‹œê°:</div>
        <div id="nextTime" class="mono">-</div>

        <div class="label">ì´ë²ˆ ë¶„ ë¹„í”„ ì˜¤í”„ì…‹:</div>
        <div id="offsets" class="mono hint">-</div>
      </div>

      <div id="status" class="status hint">ëŒ€ê¸° ì¤‘</div>
      <div class="hint" style="margin-top:8px;">â€» ì²« ì‹¤í–‰ì€ <b>Start ë²„íŠ¼ í´ë¦­</b>ì´ í•„ìš”í•©ë‹ˆë‹¤(ë¸Œë¼ìš°ì € ìë™ì¬ìƒ ì •ì±…). iPhoneì€ ë¬´ìŒëª¨ë“œ í•´ì œ.</div>
    </div>

    <!-- ğŸ”Š ì˜¤ë””ì˜¤ ì„¤ì •: ë³¼ë¥¨ 1í–‰ + íŒŒí˜•/íŒ¨í„´ 2ì—´ 1í–‰ -->
    <div class="panel audio-panel">
      <h3 style="margin:6px 0 12px;">ğŸ”Š ì˜¤ë””ì˜¤ ì„¤ì •</h3>

      <!-- ë³¼ë¥¨ -->
      <div style="margin-bottom:12px;">
        <div class="hint" style="margin-bottom:4px;">ë³¼ë¥¨</div>
        <input id="volSlider" class="slider" type="range" min="0" max="100" value="80" />
        <div class="hint mono"><span id="volVal">80</span>%</div>
      </div>

      <!-- íŒŒí˜• + íŒ¨í„´: 2ì—´ 1í–‰ -->
      <div class="grid-2">
        <div>
          <div class="hint" style="margin-bottom:4px;">íŒŒí˜• (Timbre)</div>
          <select id="selWave">
            <option value="sine">sine (ë¶€ë“œëŸ¬ì›€)</option>
            <option value="square" selected>square (ëšœë ·í•¨)</option>
            <option value="triangle">triangle (brightness)</option>
            <option value="sawtooth">sawtooth (ë‚ ì¹´ë¡œì›€)</option>
          </select>
        </div>
        <div>
          <div class="hint" style="margin-bottom:4px;">ë¹„í”„ íŒ¨í„´</div>
          <select id="selPattern">
            <option value="double">ë”ë¸” ë¹„í”„</option>
            <option value="triple">íŠ¸ë¦¬í”Œ ë¹„í”„</option>
            <option value="long" selected>ì¥ìŒ 1íšŒ (ê¸°ë³¸)</option>
            <option value="rise">ìƒìŠ¹ 2ìŒ</option>
            <option value="fall">í•˜ê°• 2ìŒ</option>
          </select>
        </div>
      </div>

      <div class="test-row" style="margin-top:10px;">
        <button id="btnTest" class="btn">Beep Test</button>
        <button id="btnResume" class="btn secondary">ì˜¤ë””ì˜¤ ì¼œê¸°</button>
      </div>
    </div>
  </div>

<script>
(function(){
  // ====== Audio Core ======
  let audioCtx = null;
  function ensureAudio() {
    if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    if (audioCtx.state === "suspended") audioCtx.resume();
  }

  // ê¸°ë³¸ê°’ì„ square + long ìœ¼ë¡œ ë³€ê²½
  const audioCfg = { volume: 0.8, wave: "square", pattern: "long" };

  function tone({startTime, freq=900, ms=140, wave, gainVol}) {
    if (!audioCtx) return;
    const osc = audioCtx.createOscillator();
    const gain = audioCtx.createGain();

    osc.type = wave || audioCfg.wave;
    osc.frequency.value = freq;

    const attack = 0.005, release = 0.09;
    gain.gain.setValueAtTime(0.0001, startTime);
    gain.gain.exponentialRampToValueAtTime(Math.max(Math.min(gainVol ?? audioCfg.volume, 1), 0), startTime + attack);
    gain.gain.exponentialRampToValueAtTime(0.0001, startTime + ms/1000 + release);

    osc.connect(gain).connect(audioCtx.destination);
    osc.start(startTime);
    osc.stop(startTime + ms/1000 + release);
  }

  function playBeepPattern() {
    if (!audioCtx) return;
    const now = audioCtx.currentTime;
    switch (audioCfg.pattern) {
      case "double":
        tone({startTime: now, freq: 900, ms: 140});
        tone({startTime: now + 0.12, freq: 900, ms: 140});
        break;
      case "triple":
        tone({startTime: now, freq: 920, ms: 120});
        tone({startTime: now + 0.12, freq: 920, ms: 120});
        tone({startTime: now + 0.24, freq: 920, ms: 120});
        break;
      case "long":
        tone({startTime: now, freq: 700, ms: 380});
        break;
      case "rise":
        tone({startTime: now, freq: 700, ms: 130});
        tone({startTime: now + 0.12, freq: 980, ms: 160});
        break;
      case "fall":
        tone({startTime: now, freq: 980, ms: 130});
        tone({startTime: now + 0.12, freq: 700, ms: 160});
        break;
    }
  }

  function flash() {
    const orig = document.body.style.backgroundColor;
    document.body.style.backgroundColor = "rgba(255,235,59,0.35)";
    setTimeout(()=>{ document.body.style.backgroundColor = orig || ""; }, 120);
  }

  // ====== DOM ======
  const clockEl = document.getElementById("clock");
  const btnStart = document.getElementById("btnStart");
  const btnStop  = document.getElementById("btnStop");
  const inpN     = document.getElementById("inpN");
  const chkAlign = document.getElementById("chkAlign");
  const chkIncludeZero = document.getElementById("chkIncludeZero");
  const chkVisualBeep  = document.getElementById("chkVisualBeep");
  const countdownEl = document.getElementById("countdown");
  const nextTimeEl  = document.getElementById("nextTime");
  const offsetsEl   = document.getElementById("offsets");
  const statusEl    = document.getElementById("status");

  const volSlider = document.getElementById("volSlider");
  const volVal = document.getElementById("volVal");
  const selWave = document.getElementById("selWave");
  const selPattern = document.getElementById("selPattern");
  const btnTest = document.getElementById("btnTest");
  const btnResume = document.getElementById("btnResume");

  // ====== Timer State ======
  let running = false;
  let uiTimerId = null;
  let tickTimerId = null;
  let minuteBaseTs = null;   // ì´ë²ˆ ë¶„ì˜ :00(ms)
  let scheduleOffsets = [];  // ì´ë²ˆ ë¶„ ì˜¤í”„ì…‹(ms)
  let nextTs = null;
  const PERIOD = 60_000;

  // ====== Utils ======
  const two = n => String(n).padStart(2, "0");
  const fmtClock = d => `${two(d.getHours())}:${two(d.getMinutes())}:${two(d.getSeconds())}`;
  const fmtTime = ts => ts ? fmtClock(new Date(ts)) : "-";
  function clampN(n){ if (Number.isNaN(n) || n < 1) return 1; if (n > 60) return 60; return n; }

  function computeMinuteBase(nowMs) {
    const d = new Date(nowMs);
    d.setMilliseconds(0);
    d.setSeconds(0);
    return d.getTime(); // í•­ìƒ ë¶„ì˜ 0ì´ˆ
  }

  // includeZero ì„ íƒ ì‹œ 0 í¬í•¨
  function buildOffsets(nSec, includeZero) {
    const offs = [];
    if (includeZero) offs.push(0);
    const limit = Math.floor(59 / nSec);
    for (let k=1; k<=limit; k++) offs.push(k * nSec);
    return offs.map(s => s * 1000);
  }

  function recalcSchedule() {
    const n = clampN(parseInt(inpN.value, 10));
    scheduleOffsets = buildOffsets(n, chkIncludeZero.checked);
    offsetsEl.textContent = scheduleOffsets.length
      ? scheduleOffsets.map(ms => (ms/1000) + "s").join(", ")
      : "(ì´ë²ˆ ë¶„ ìš¸ë¦¼ ì—†ìŒ)";
  }

  // í˜„ì¬ ë¶„ì˜ ë‚¨ì€ ì˜¤í”„ì…‹ ì¤‘ â€˜ì§€ê¸ˆ ì´í›„â€™ ì²« ë¹„í”„ë¥¼ ì‚¬ìš©
  function findNextBeepTs(nowMs) {
    const candidates = scheduleOffsets.map(off => minuteBaseTs + off).filter(ts => ts > nowMs).sort((a,b)=>a-b);
    if (candidates.length) return candidates[0];
    // ì—†ìœ¼ë©´ ë‹¤ìŒ ë¶„ìœ¼ë¡œ ë„˜ê²¨ ì²« ì˜¤í”„ì…‹
    minuteBaseTs += PERIOD;
    return scheduleOffsets.length ? (minuteBaseTs + scheduleOffsets[0]) : (minuteBaseTs + PERIOD + 1000);
  }

  // ====== Core Flow ======
  function start() {
    if (running) return;
    ensureAudio();

    inpN.value = clampN(parseInt(inpN.value, 10));
    running = true;
    btnStart.disabled = true;
    btnStop.disabled  = false;

    const now = Date.now();

    // :00 ê¸°ì¤€ìœ¼ë¡œ ìŠ¤ì¼€ì¤„ êµ¬ì„±, â€œí˜„ì¬ ë¶„ì˜ ë‚¨ì€ ì˜¤í”„ì…‹â€ ì¤‘ ê°€ì¥ ê°€ê¹Œìš´ ê²ƒìœ¼ë¡œ ì¦‰ì‹œ ì‹œì‘
    minuteBaseTs = computeMinuteBase(now);
    recalcSchedule();

    statusEl.textContent = chkAlign.checked
      ? "ì‹¤í–‰ ì¤‘ (:00 ì •ê° ê¸°ì¤€ n,2n,â€¦) â€” í˜„ì¬ ë¶„ì˜ ë‚¨ì€ ì˜¤í”„ì…‹ ì¦‰ì‹œ ë°˜ì˜"
      : "ì‹¤í–‰ ì¤‘ (:00 ê¸°ì¤€, í˜„ì¬ ë¶„ì˜ ê°€ì¥ ê°€ê¹Œìš´ ì˜¤í”„ì…‹ë¶€í„° ì‹œì‘)";
    statusEl.className = "status hint";

    nextTs = findNextBeepTs(now);

    clearInterval(uiTimerId);
    uiTimerId = setInterval(updateUI, 200);
    scheduleNext();
  }

  function stop() {
    running = false;
    clearTimeout(tickTimerId);
    clearInterval(uiTimerId);
    btnStart.disabled = false;
    btnStop.disabled  = true;
    countdownEl.textContent = "-";
    nextTimeEl.textContent = "-";
    statusEl.textContent = "ì •ì§€";
    statusEl.className = "status hint";
  }

  function scheduleNext() {
    if (!running) return;
    const now = Date.now();
    let delay = Math.max(0, nextTs - now);
    if (delay > PERIOD) delay = PERIOD; // ë°±ê·¸ë¼ìš´ë“œ ìŠ¤ë¡œí‹€ ëŒ€ì‘
    clearTimeout(tickTimerId);
    tickTimerId = setTimeout(onTick, delay);
    updateUI();
  }

  function onTick() {
    if (!running) return;

    playBeepPattern();
    if (chkVisualBeep.checked) flash();

    const now = Date.now();
    // ì´ë²ˆ ë¶„ì˜ ë‹¤ìŒ ì˜¤í”„ì…‹ ì°¾ê³ , ì—†ìœ¼ë©´ ë‹¤ìŒ ë¶„ìœ¼ë¡œ ë¡¤ì˜¤ë²„
    const remaining = scheduleOffsets.map(off => minuteBaseTs + off).filter(ts => ts > now).sort((a,b)=>a-b);
    if (remaining.length) {
      nextTs = remaining[0];
    } else {
      minuteBaseTs = computeMinuteBase(now + PERIOD);
      recalcSchedule();
      nextTs = scheduleOffsets.length ? (minuteBaseTs + scheduleOffsets[0]) : (minuteBaseTs + PERIOD + 1000);
    }
    scheduleNext();
  }

  function updateUI() {
    const d = new Date();
    clockEl.textContent = fmtClock(d);

    if (!running) return;
    const now = Date.now();
    const remainMs = Math.max(0, nextTs - now);
    const secs = Math.ceil(remainMs / 1000);
    countdownEl.textContent = two(secs) + " s";
    nextTimeEl.textContent = fmtTime(nextTs);
  }

  // ====== Events ======
  btnStart.addEventListener("click", start);
  btnStop.addEventListener("click", stop);

  inpN.addEventListener("change", () => {
    inpN.value = clampN(parseInt(inpN.value, 10));
    recalcSchedule();
    if (running) {
      const now = Date.now();
      nextTs = findNextBeepTs(now); // ë³€ê²½ ì¦‰ì‹œ ë°˜ì˜
      scheduleNext();
      statusEl.textContent = "ê°„ê²© ë³€ê²½: í˜„ì¬ ë¶„ì˜ ë‚¨ì€ ì˜¤í”„ì…‹ì„ ê¸°ì¤€ìœ¼ë¡œ ì¦‰ì‹œ ë°˜ì˜";
    }
  });

  chkIncludeZero.addEventListener("change", () => {
    recalcSchedule();
    if (running) {
      const now = Date.now();
      nextTs = findNextBeepTs(now);
      scheduleNext();
      statusEl.textContent = "ì •ê° í¬í•¨ ì—¬ë¶€ ë³€ê²½: í˜„ì¬ ë¶„ ê¸°ì¤€ìœ¼ë¡œ ì¦‰ì‹œ ë°˜ì˜";
    }
  });

  chkAlign.addEventListener("change", () => {
    // v3ì—ì„œë„ :00 ê¸°ì¤€ì€ ë™ì¼ ìœ ì§€, í˜„ì¬ ë¶„ ì¦‰ì‹œ ë°˜ì˜ ë°©ì‹ ìœ ì§€
    statusEl.textContent = running
      ? "ì •ê° ë™ê¸°í™” ì˜µì…˜ ë³€ê²½ë¨ (í˜„ ë¶„ ê¸°ì¤€ ìœ ì§€)"
      : "ëŒ€ê¸° ì¤‘";
  });

  // ì˜¤ë””ì˜¤ ì„¤ì •
  volSlider.addEventListener("input", () => {
    volVal.textContent = volSlider.value;
    audioCfg.volume = Math.max(0, Math.min(1, volSlider.value / 100));
  });
  selWave.addEventListener("change", () => { audioCfg.wave = selWave.value; });
  selPattern.addEventListener("change", () => { audioCfg.pattern = selPattern.value; });
  btnTest.addEventListener("click", () => { ensureAudio(); playBeepPattern(); });
  btnResume.addEventListener("click", () => { ensureAudio(); });

  // íƒ­ ë³µê·€ ì‹œ ë“œë¦¬í”„íŠ¸ ë³´ì •
  document.addEventListener("visibilitychange", () => {
    if (!running) return;
    const now = Date.now();
    if (now - nextTs > PERIOD) {
      minuteBaseTs = computeMinuteBase(now);
      recalcSchedule();
      nextTs = findNextBeepTs(now);
      scheduleNext();
    } else {
      scheduleNext();
    }
  });

  // ì´ˆê¸° UI ë™ê¸°í™” (DOMì˜ ê¸°ë³¸ ì„ íƒê°’ì„ ë°˜ì˜)
  volVal.textContent = volSlider.value;
  audioCfg.volume = volSlider.value / 100;
  audioCfg.wave = document.getElementById("selWave").value;
  audioCfg.pattern = document.getElementById("selPattern").value;
  recalcSchedule();
  setInterval(() => { clockEl.textContent = fmtClock(new Date()); }, 200);
})();
</script>
</body>
</html>
